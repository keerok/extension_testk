Okta.WebExtension=function(n,f,o,r){var d=PLUGIN_VERSIONS.currentVersion;var e=_okta.delay,c=_okta.extend,t=_okta.each,l=_okta.filter,g=_okta.find,a=_okta.where,h=_okta.map,m=_okta.sortBy,p=_okta.first,i=Okta.Q.defer,s=Okta.Q,b=Okta.Q.allSettled,u=Okta.Events,v=Okta.fn.base.curry2,k=Okta.fn.base.always,w=Okta.fn.url.getMonitoredSitesApiMatchPatterns,S=Okta.fn.url.isOktaPage,O=Okta.fn.url.isOktaEndUserHomeHref,L=Okta.fn.url.hrefToUrlParts,I=Okta.fn.url.isCustomEndUserHomeHref,T=Okta.fn.bg.findAuthSite,x=Okta.fn.bg.getDomains,C=Okta.fn.bg.getLastAuthTimestamp,A=Okta.fn.bg.setLastAuthTimestamp,U=Okta.fn.bg.getBasicAuthCreds,P=Okta.fn.bg.getPendingConsentAccount,y=Okta.Url,q=r==="firefox",D=r==="edge",R=r==="safari",H=new Okta.AuthenticationMonitor(n,f,o,r),W=new Okta.SuppressPwdSave,_=c({},u),E=75,B=300,j=Okta.fn.bg.chromeP,M=Okta.fn.script;var F=2*1e3,N=1e3;function z(n){return j.tabs.query({}).then(function(e){var t=a(e,{id:n}).length>0;if(!t){return null}return j.tabs.get(n)})}function V(t,e){var n=i(),r=e===undefined?30:e;z(t).then(function(e){if(e&&(!D||e.status==="complete")){n.resolve(e)}else if(r>1){window.setTimeout(function(){V(t,r-1).then(n.resolve)},B)}else{n.resolve(null)}});return n.promise}function Q(e){return/^http/.test(e)}function X(e){var t=e.tabId,n=e.frameId;if(n==0){W.deleteSuppressTab(t,true)}if(!Q(e.url)){console.log("Skipped url: "+e.url);return}if(S(L(e.url),"/oauth2/v1/authorize")){console.log("Skip Okta OAuth authorize url: "+e.url);return}return z(t).then(function e(t){if(!t||!Q(t.url)){return}M.injectPreloadScript(t.id,n)})}_.injectContentScript=M.injectContentScript;function G(e,t){_.trigger("messageFromContent",{msg:t,tabId:e.sender&&e.sender.tab?e.sender.tab.id:-1,frameId:e.sender?e.sender.frameId:0,portInfo:{port:e}})}function J(e){var t="X-Okta-User-Agent-Extended",n="okta-browser-plugin/"+d,r={requestHeaders:[]},o="X-Okta-User-Agent-Account-Data";if(e.requestHeaders){r.requestHeaders=e.requestHeaders}try{var a=null,i=false,s=O&&O(e.url);if(!s&&I){a=x(f);if(a&&a.customDomain&&a.oktaDomain){i=I(e.url,a.customDomain)}}if(s||i){var u=g(r.requestHeaders,function(e){return e.name.toLowerCase()===t.toLowerCase()});var c=P?P(f,i?a:null):"";if(u){u.value+=" "+n}else{r.requestHeaders.push({name:t,value:n});r.requestHeaders.push({name:o,value:c})}}}catch(e){Log.error("WebExtension::onBeforeSendHeaders Error: "+e.message)}return r}function K(e){var r,t;r=T(f,new y(e.url));if(!r||!r.credURI){return Promise.reject()}t=C(n,r.authURL);if(e.timeStamp-t<F){return Promise.reject()}A(n,r.authURL,e.timeStamp);return new Promise(function(t,n){U(o,f,r.credURI).then(function(e){if(e&&e.u&&e.p){t({authCredentials:{username:e.u,password:e.p}})}else{n()}}).fail(n)})}function Y(e,t){K(e).then(function(e){t(e)}).catch(function(){t()})}function Z(){e(function(){H.initialize()},N)}function $(){if(q){return window&&window.navigator&&window.navigator.userAgent&&parseInt(window.navigator.userAgent.toLowerCase().split("firefox/").pop())>=E}return!D&&!R}function ee(){return j.tabs.create({url:"https://login.okta.com",active:false}).then(function(t){return V(t.id).then(function(e){if(!e){return[]}return j.tabs.executeScript(t.id,{code:"localStorage.getItem('okta_accounts');"}).then(function(e){_.closeTab(t.id);if(e&&e.length===1){return JSON.parse(e[0])}return[]})})})}_.getType=k(r);_.getBackgroundVersion=k(d);_.post=function e(t){if(!t.portInfo.port.isDisconnected){t.portInfo.port.postMessage(t.msg)}};_.openTab=function(e){if(!e){return}switch(r){case"chrome":case"edge-chromium":case"safari":chrome.tabs.create({url:e});break;case"edge":chrome.tabs.create({url:e.split("?")[0]});break;case"firefox":chrome.tabs.create({url:e});var t=chrome.extension.getViews({type:"popup"});if(t.length!=1){Log.warn("WebExtension::openTab: "+"Did not close popup. Windows count: "+t.length);return}t[0].close();break;default:Log.error("WebExtension::openTab: Unknown browser type!")}};_.openTabForAccountChooser=function(n){if(!n){return s()}return j.tabs.query({active:true}).then(function(e){if(!e||!e.length){chrome.tabs.create({url:n});return}var t=e[0];if(t.url.indexOf(n)===-1){chrome.tabs.create({url:n});return}if(D){_.openTab(n);_.closeTab(t.id)}else{chrome.tabs.reload()}})};_.openPermissionsPage=function(){Log.info("open permissions page");chrome.tabs.create({url:chrome.runtime.getURL("shared/settings-page/permissions.html")})};_.servePopover=function(){Log.info("serve popover");chrome.tabs.update({url:chrome.runtime.getURL("shared/popover/popover.html")})};_.closeTab=function(e){if(e){chrome.tabs.remove(e)}};_.getCookies=function(e,n,t){var r={url:e};function o(e){return j.cookies.getAll(e).then(function(e){var t=l(e,function(e){return n.indexOf(e.name)>-1});return t})}if(typeof t!=="undefined"){return j.tabs.get(t).then(function(e){if(e&&e.cookieStoreId){r.storeId=e.cookieStoreId}return o(r)})}return o(r)};_.updateBadge=function(e){if(!e){return}chrome.browserAction.setBadgeText({text:e.text});if(e.color!==""){chrome.browserAction.setBadgeBackgroundColor({color:e.color})}};_.getLocalStorageUsage=function(){var t=i(),e=0;try{for(var n=0;n<localStorage.length;++n){e+=localStorage.getItem(localStorage.key(n)).length}Log.info("WebExtension::getLocalStorageUsage: {0} bytes used",e);t.resolve(e)}catch(e){Log.error("WebExtension::getLocalStorageUsage Error: {0}",e);t.reject(e)}return t.promise};_.isInstalledByUser=function(){if(!j.management.getSelf){return s(false)}return j.management.getSelf().then(function(e){var t=e&&e.installType;return t==="normal"||t==="development"})};_.getOrgsWithSessionCookies=function(){var r=i();ee().then(function(n){if(!n||n.length===0){r.resolve({oktaAccounts:[],sessions:[]});return}var u=[];var e=h(n,function(i){return _.getCookies(i.origin+"/app/UserHome",["sid","DT","idx"]).then(function(e){var t=function(t){return g(e,function(e){return e.name===t})};var n=t("sid");var r=t("DT");var o=t("idx");if(n&&r||o){var a=i.origin;u.push({domain:a,sid:n&&n.value,dt:r&&r.value,idx:o&&o.value})}})});b(e).then(function(e){t(e,function(e){if(e.state!=="fulfilled"){Log.warn("WebExtension::getOrgsWithSessionCookies: Unable to fulfill getCookies: "+e.reason)}});if(u.length===0){r.resolve({oktaAccounts:n,sessions:[]});return}chrome.windows.getCurrent({},function(s){var e=h(u,function(e){return e.domain+"/*"});chrome.tabs.query({url:e},function(a){if(!a||a.length===0){r.resolve({oktaAccounts:n,sessions:u})}var i=function(e){var t=0;if(e.isDashboardTab){t-=100}if(e.isInCurrentWindow){t-=10}if(e.id!==undefined&&e.index!==undefined){t-=1}return t};var e=h(u,function(t){var e=l(a,function(e){return e.url.indexOf(t.domain)!==-1});if(!e||e.length===0){return t}var n=h(e,function(e){var t=L&&L(e.url);return c(e,{isDashboardTab:t&&t.path==="/app/UserHome",isInCurrentWindow:e.windowId===s.id})});var r=m(n,i);var o=p(r);return c(t,{tabId:o.id,tabIndex:o.index,isDashboardTab:o.isDashboardTab,isInCurrentWindow:o.isInCurrentWindow})});var t=m(e,i);r.resolve({oktaAccounts:n,sessions:t})})})})});return r.promise};_.highlightAndRefreshTab=function(e){if(D){return z(e).then(function(e){if(e){_.openTab(e.url);_.closeTab(e.id)}})}chrome.tabs.reload(e);return j.tabs.get(e).then(function(e){chrome.tabs.highlight({tabs:[e.index],windowId:e.windowId});chrome.windows.update(e.windowId,{focused:true})})};_.setUninstallURL=function(e){chrome.runtime.setUninstallURL(e)};var te=v(G),ne=chrome.runtime.onConnect,re=chrome.runtime.onInstalled,oe=chrome.webRequest.onCompleted,ae={urls:["<all_urls>"]},ie=Y,se=["asyncBlocking"];if(q){ie=K;se=["blocking"]}if(D){ae.types=["main_frame","sub_frame"];oe=chrome.webNavigation.onCompleted}chrome.webNavigation.onDOMContentLoaded.addListener(X);chrome.webRequest.onBeforeSendHeaders.addListener(J,ae,["requestHeaders","blocking"]);ne.addListener(function e(t){t.onMessage.addListener(te(t));t.onDisconnect.addListener(function(){t.isDisconnected=true})});re&&re.addListener(function(e){var t=e&&e.reason;if(t!=="install"){return}_.trigger("postInstall")});chrome.webRequest.onAuthRequired&&chrome.webRequest.onAuthRequired.addListener(ie,{urls:["<all_urls>"]},se);oe&&oe.addListener(Z,{urls:w(),types:["xmlhttprequest"]});H.initialize(false);if(!!$()){_.suppressSavePassword=W.turnOffSavePasswordFeature;_.hasPrivacyPermissions=W.hasPrivacyPermissions;_.getPasswordSavingDetails=W.getPasswordSavingDetails}W.restoreSavePassword();function ue(e){W.checkSuppressTabOnActivate(e.tabId)}function ce(e){W.deleteSuppressTab(e)}function fe(e,t){W.deleteSuppressTab(t)}function de(e){W.checkSuppressTabOnWindowFocusChange(e)}chrome.tabs.onActivated.addListener(ue);chrome.tabs.onRemoved.addListener(ce);chrome.tabs.onReplaced.addListener(fe);chrome.windows.onFocusChanged.addListener(de);return _};