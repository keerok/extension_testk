Okta.Auth=function(u,d,s,o){var i,a=_okta.extend,r=_okta.clone,c=_okta.find,f=_okta.each,h=Okta.fn.authUtil.getDefaultOAuthParams,l=Okta.fn.authUtil.toQueryParams,k=Okta.fn.authUtil.getOAuthUrls,g=Okta.fn.authUtil.convertOAuthParamsToQueryParams,p=Okta.fn.authUtil.validateResponse,v=Okta.fn.authUtil.validateOptions,m=Okta.fn.authUtil.validateClaims,w=Okta.fn.authUtil.decodeToken,E=Okta.Q,e=Okta.Constants.AuthOptions.PKCE,_=e.DEFAULT_CODE_CHALLENGE_METHOD,U=e.MIN_VERIFIER_LENGTH,O=e.MAX_VERIFIER_LENGTH,n=o.isSubtleCryptoSupportedForAuth(),t={};function y(e,t){t=r(t)||{};var n=h(e);return a(n,t),n.codeChallengeMethod||(n.codeChallengeMethod=_),n.responseType="code",function e(t){var n=t+"/.well-known/openid-configuration";return s.getOktaUnauthenticatedRequest(n)}(e.oktaDomain).then(function(e){if(-1===(e.code_challenge_methods_supported||[]).indexOf(n.codeChallengeMethod))throw new Error("Invalid code_challenge_method");i=e.jwks_uri}).then(function(){var e=function e(t){var n=t||"";return n.length<U&&(n+=o.generateRandomString(U-n.length)),encodeURIComponent(n).slice(0,O)}(n.codeVerifier),t={codeVerifier:e,redirectUri:n.redirectUri};return d.setPKCEMeta(t).then(function(){return o.computeChallenge(e)})}).then(function(e){return a({},n,{codeChallenge:e})})}function T(t,e,n){var r=E.defer();function o(e){if(e.data&&e.data.state===n)return e.origin!==t.url?r.reject(new Error("The request does not match client configuration")):void r.resolve(e.data)}return function e(t,n,r){t.addEventListener?t.addEventListener(n,r):t.attachEvent("on"+n,r)}(window,"message",o),r.promise.timeout(e||12e4,new Error("OAuth flow timed out")).fin(function(){!function e(t,n,r){t.removeEventListener?t.removeEventListener(n,r):t.detachEvent("on"+n,r)}(window,"message",o)})}function C(n,r){return E().then(function(){if(!n||!n.idToken)throw new Error("Only idTokens may be verified");var e=w(n.idToken),t={clientId:u.clientId,issuer:u.issuer||u.url,ignoreSignature:u.ignoreSignature};return a(t,r),m(e.payload,t),1==t.ignoreSignature?n:function e(t,n){if(!i)throw new Error("jwks_url is not in "+t+"./well-known/openid-configuration");return s.getOktaUnauthenticatedRequest(i).then(function(e){var t=c(e.keys,function(e){return e.kid==n});if(t)return t;throw new Error("The key id, "+n+", was not found in the server's keys")})}(n.issuer,e.header.kid).then(function(e){return o.verifyAuthIdToken(n.idToken,e,!0)}).then(function(e){if(!e||!e.valid)throw new Error("The token signature is not valid");return n})})}function I(e,i,t,a){a=a||{};var n=i.responseType,u=r(i.scopes),c=i.clientId||e.clientId;return E().then(function(){if(p(t,i),t.code)return n=["access_token","id_token"],function e(n,r,o){return d.getPKCEMeta().then(function(e){var t={clientId:n.clientId,authorizationCode:r,codeVerifier:e.codeVerifier,redirectUri:e.redirectUri};return v(t),s.getAccessToken(o.tokenUrl,{client_id:t.clientId,redirect_uri:t.redirectUri,grant_type:"authorization_code",code:t.authorizationCode,code_verifier:t.codeVerifier}).then(function(e){return p(e,t),e})}).fin(function(){d.clearPKCEMeta()})}(i,t.code,a);throw new Error("authroize message does not have code")}).then(function(e){var t={};if(e.access_token&&(t.access_token={accessToken:e.access_token,expiresAt:Number(e.expires_in)+Math.floor(Date.now()/1e3),tokenType:e.token_type,scopes:u,authorizeUrl:a.authorizeUrl,userinfoUrl:a.userinfoUrl}),e.id_token){var n=w(e.id_token),r={idToken:e.id_token,claims:n.payload,expiresAt:n.payload.exp,scopes:u,authorizeUrl:a.authorizeUrl,issuer:a.issuer,clientId:c},o={clientId:c,issuer:a.issuer,nonce:i.nonce};return i.ignoreSignature!==undefined&&(o.ignoreSignature=i.ignoreSignature),C(r,o).then(function(){return t.id_token=r,t})}return t}).then(function(t){return f(n,function(e){if(!t[e])throw new Error("Unable to parse OAuth flow response: "+e+" was not returned.")}),d.setAuthTokenByDomain(e.oktaDomain,t).then(function(){return Log.debug("sucessfully got token for domain {0}",e.oktaDomain),t})})}function A(e,a){return a=a||{},y(u,e=e||{}).then(function(t){var e,n;n=k(u);var r=g(t);e=n.authorizeUrl+"?"+l(r);var o=T(u,a.timeout,t.state),i=function e(t){var n=document.createElement("iframe");return n.style.display="none",n.src=t,document.body.appendChild(n)}(e);return o.then(function(e){return I(u,t,e,n)}).fin(function(e){return document.body.contains(i)&&i.parentElement.removeChild(i),e})})}return t.token={},t.token.getWithoutPrompt=function(e,t){if(!u.url)throw new Error("missing url in sdkOptions");if(!n.supported)throw new Error(n.message);return A(e,t)},t};